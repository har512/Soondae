<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css">
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        /* ê°„ë‹¨í•œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .result-item {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg text-center">
        <h1 class="text-2xl font-bold mb-2 text-gray-800">ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë¶„ì„ê¸°</h1>
        <p class="text-gray-500 mb-6">ë‚´ë³´ë‚´ê¸°í•œ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”(.txt) íŒŒì¼ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
        
        <label for="fileInput" class="w-full cursor-pointer bg-yellow-300 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-yellow-400 transition-colors duration-300 inline-block">
            ğŸ“‚ íŒŒì¼ ì„ íƒí•˜ê¸°
        </label>
        <input type="file" id="fileInput" accept=".txt" class="hidden">
        <p id="fileName" class="text-sm text-gray-600 mt-3 h-5"></p>

        <div class="grid grid-cols-2 gap-4 mt-4">
            <button id="analyzeDailyBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ì˜¤ëŠ˜/ì–´ì œ ìˆœìœ„
            </button>
            <button id="analyzeWeeklyBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ì§€ë‚œ 7ì¼ê°„ ìˆœìœ„
            </button>
            <button id="analyzeMonthlyStatusBtn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ë” ì¹œí•´ì ¸ìš”
            </button>
            <button id="downloadBtn" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                CSV ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
        
        <div id="message" class="mt-4 text-sm h-5"></div>

        <!-- ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë  ì˜ì—­ -->
        <div id="analysisResult" class="mt-6 text-left"></div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let parsedChatData = [];
        let csvContent = '';

        // --- DOM ìš”ì†Œ ---
        const fileInput = document.getElementById('fileInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const analyzeDailyBtn = document.getElementById('analyzeDailyBtn');
        const analyzeWeeklyBtn = document.getElementById('analyzeWeeklyBtn');
        const analyzeMonthlyStatusBtn = document.getElementById('analyzeMonthlyStatusBtn');
        const fileNameEl = document.getElementById('fileName');
        const messageEl = document.getElementById('message');
        const analysisResultEl = document.getElementById('analysisResult');

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        fileInput.addEventListener('change', handleFileSelect);
        downloadBtn.addEventListener('click', handleDownload);
        analyzeDailyBtn.addEventListener('click', handleDailyAnalysis);
        analyzeWeeklyBtn.addEventListener('click', handleWeeklyAnalysis);
        analyzeMonthlyStatusBtn.addEventListener('click', handleMonthlyStatus);

        // --- í•¨ìˆ˜ ì •ì˜ ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                resetUI();
                return;
            }
            fileNameEl.textContent = file.name;
            resetUI(false);
            messageEl.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘...';
            messageEl.className = 'mt-4 text-sm h-5 text-blue-600';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const fileContent = e.target.result;
                    parsedChatData = parseKakaoTalkLogExcelSafe(fileContent);
                    if (parsedChatData.length > 0) {
                        csvContent = convertToCSV(parsedChatData);
                        downloadBtn.disabled = false;
                        analyzeDailyBtn.disabled = false;
                        analyzeWeeklyBtn.disabled = false;
                        analyzeMonthlyStatusBtn.disabled = false;
                        messageEl.textContent = `ğŸ‰ ${parsedChatData.length}ê°œ ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ!`;
                        messageEl.className = 'mt-4 text-sm h-5 text-green-600';
                    } else {
                        throw new Error("ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                } catch (err) {
                    resetUI(false);
                    messageEl.textContent = `âš ï¸ ì˜¤ë¥˜: ${err.message}`;
                    messageEl.className = 'mt-4 text-sm h-5 text-red-600';
                }
            };
            reader.onerror = () => {
                resetUI();
                messageEl.textContent = 'âš ï¸ íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                messageEl.className = 'mt-4 text-sm h-5 text-red-600';
            };
            reader.readAsText(file, 'UTF-8');
        }

        function handleDailyAnalysis() {
            if (parsedChatData.length === 0) return;
            let chatsToAnalyze = [];
            let analysisDateString = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaysChats = parsedChatData.filter(chat => {
                const chatDate = new Date(chat.Timestamp);
                chatDate.setHours(0, 0, 0, 0);
                return chatDate.getTime() === today.getTime();
            });
            if (todaysChats.length > 0) {
                chatsToAnalyze = todaysChats;
                analysisDateString = 'ì˜¤ëŠ˜';
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);
                const yesterdaysChats = parsedChatData.filter(chat => {
                    const chatDate = new Date(chat.Timestamp);
                    chatDate.setHours(0, 0, 0, 0);
                    return chatDate.getTime() === yesterday.getTime();
                });
                if (yesterdaysChats.length > 0) {
                    chatsToAnalyze = yesterdaysChats;
                    analysisDateString = 'ì–´ì œ';
                }
            }
            if (chatsToAnalyze.length === 0) {
                displayAnalysisResult([], 'ì˜¤ëŠ˜ê³¼ ì–´ì œ');
                return;
            }
            const userCounts = countUserMessages(chatsToAnalyze);
            const top5 = getTopUsers(userCounts);
            displayAnalysisResult(top5, analysisDateString);
        }

        function handleWeeklyAnalysis() {
            if (parsedChatData.length === 0) return;
            const now = new Date();
            const sevenDaysAgo = new Date(now);
            sevenDaysAgo.setDate(now.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0); // 7ì¼ ì „ ìì •ë¶€í„° ê³„ì‚°

            const last7DaysChats = parsedChatData.filter(chat => {
                const chatDate = new Date(chat.Timestamp);
                return chatDate >= sevenDaysAgo;
            });

            if (last7DaysChats.length === 0) {
                displayAnalysisResult([], 'ì§€ë‚œ 7ì¼ê°„');
                return;
            }
            const userCounts = countUserMessages(last7DaysChats);
            const top5 = getTopUsers(userCounts);
            displayAnalysisResult(top5, 'ì§€ë‚œ 7ì¼ê°„');
        }

        function handleMonthlyStatus() {
            if (parsedChatData.length === 0) return;
            const now = new Date();
            const monthlyChats = parsedChatData.filter(chat => {
                const chatDate = new Date(chat.Timestamp);
                return chatDate.getFullYear() === now.getFullYear() && chatDate.getMonth() === now.getMonth();
            });
            if (monthlyChats.length === 0) {
                displayWarningList([], 'ì´ë²ˆ ë‹¬');
                return;
            }
            const userCounts = countUserMessages(monthlyChats);
            const warningUsers = Object.entries(userCounts)
                .filter(([user, count]) => count < 50)
                .sort((a, b) => a[1] - b[1]); // ëŒ€í™” ìˆ˜ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
            displayWarningList(warningUsers, 'ì´ë²ˆ ë‹¬');
        }
        
        function countUserMessages(chatList) {
            const userCounts = {};
            chatList.forEach(chat => {
                if (chat.User !== 'ì‹œìŠ¤í…œ' && chat.User !== 'ê´€ë¦¬ì') {
                    userCounts[chat.User] = (userCounts[chat.User] || 0) + 1;
                }
            });
            return userCounts;
        }

        function getTopUsers(userCounts, count = 5) {
            return Object.entries(userCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, count);
        }

        function displayAnalysisResult(ranking, dateString) {
            analysisResultEl.innerHTML = '';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-gray-800 border-b pb-2';
            title.textContent = `ğŸ‘‘ ${dateString}ì˜ ëŒ€í™”ì™• ìˆœìœ„ TOP 5`;
            analysisResultEl.appendChild(title);
            if (ranking.length === 0) {
                const noData = document.createElement('p');
                noData.className = 'text-gray-500 mt-4';
                noData.textContent = `${dateString} ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                analysisResultEl.appendChild(noData);
                return;
            }
            const list = document.createElement('ol');
            list.className = 'space-y-2';
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            ranking.forEach(([user, count], index) => {
                const item = document.createElement('li');
                item.className = 'result-item flex items-center justify-between p-2 rounded-lg bg-gray-50';
                item.style.animationDelay = `${index * 100}ms`;
                const rank = medals[index] || `${index + 1}.`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold w-8 text-lg">${rank}</span>
                        <span class="text-gray-700">${user}</span>
                    </div>
                    <span class="font-semibold text-blue-600">${count}íšŒ</span>
                `;
                list.appendChild(item);
            });
            analysisResultEl.appendChild(list);
        }

        function displayWarningList(warningList, dateString) {
            analysisResultEl.innerHTML = '';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-red-600 border-b pb-2';
            title.textContent = `â˜•ï¸ ë” ì¹œí•´ì ¸ìš” (${dateString} 50íšŒ ë¯¸ë§Œ)`;
            analysisResultEl.appendChild(title);
            if (warningList.length === 0) {
                const allActive = document.createElement('p');
                allActive.className = 'text-gray-500 mt-4';
                allActive.textContent = `ëª¨ë“  ë©¤ë²„ê°€ 50íšŒ ì´ìƒ ëŒ€í™”í–ˆìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!`;
                analysisResultEl.appendChild(allActive);
                return;
            }
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            warningList.forEach(([user, count], index) => {
                const item = document.createElement('li');
                item.className = 'result-item flex items-center justify-between p-2 rounded-lg bg-red-50';
                item.style.animationDelay = `${index * 100}ms`;
                item.innerHTML = `
                    <span class="text-gray-700">${user}</span>
                    <span class="font-semibold text-red-600">${count}íšŒ</span>
                `;
                list.appendChild(item);
            });
            analysisResultEl.appendChild(list);
        }

        function handleDownload() {
            if (!csvContent || downloadBtn.disabled) return;
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'KakaoTalk_chat_log.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function resetUI(resetFileName = true) {
            if (resetFileName) {
                fileNameEl.textContent = '';
                fileInput.value = '';
            }
            downloadBtn.disabled = true;
            analyzeDailyBtn.disabled = true;
            analyzeWeeklyBtn.disabled = true;
            analyzeMonthlyStatusBtn.disabled = true;
            messageEl.textContent = '';
            analysisResultEl.innerHTML = '';
            parsedChatData = [];
            csvContent = '';
        }

        function parseKakaoTalkLogExcelSafe(fileContent) {
            const chatData = [];
            if (!fileContent) return chatData;
            const chatPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(.*?)\s*:\s*(.*)/;
            const systemPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(.*(?:ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤)\.?)/;
            const adminPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(ê´€ë¦¬ìê°€ \d+ê°œì˜ ë©”ì‹œì§€ë¥¼ ê°€ë ¸ìŠµë‹ˆë‹¤\.)/;
            const dateSeparatorPattern = /^-+\s*\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼\s.*-+$/;
            const timestampOnlyPattern = /^\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼ (ì˜¤ì „|ì˜¤í›„) \d{1,2}:\d{2}$/;
            let currentMessageInfo = null;
            const lines = fileContent.split('\n');
            const formatTimestamp = (dateStr, amPmStr, timeStr) => {
                const datePart = dateStr.match(/(\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼/);
                const year = parseInt(datePart[1], 10);
                const month = parseInt(datePart[2], 10) - 1;
                const day = parseInt(datePart[3], 10);
                let [hour, minute] = timeStr.split(':').map(num => parseInt(num, 10));
                if (amPmStr === 'ì˜¤í›„' && hour !== 12) hour += 12;
                if (amPmStr === 'ì˜¤ì „' && hour === 12) hour = 0;
                return new Date(year, month, day, hour, minute);
            };
            const excelSafeText = (text) => {
                if (/^\d{1,2}[/-]\d{1,2}$/.test(text) || /^\d{1,2}-\d{1,2}$/.test(text)) return "'" + text;
                return text;
            };
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                const adminMatch = trimmedLine.match(adminPattern);
                const systemMatch = trimmedLine.match(systemPattern);
                const chatMatch = trimmedLine.match(chatPattern);
                const isNewMessageLine = adminMatch || systemMatch || chatMatch;
                const isIgnorableLine = dateSeparatorPattern.test(trimmedLine) || timestampOnlyPattern.test(trimmedLine);
                if (isNewMessageLine) {
                    if (currentMessageInfo) chatData.push(currentMessageInfo);
                    currentMessageInfo = null;
                    if (adminMatch) {
                        const [, date, amPm, time, message] = adminMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        chatData.push({ Timestamp: timestamp, User: 'ê´€ë¦¬ì', Message: message });
                    } else if (systemMatch) {
                        const [, date, amPm, time, message] = systemMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        chatData.push({ Timestamp: timestamp, User: 'ì‹œìŠ¤í…œ', Message: message });
                    } else if (chatMatch) {
                        const [, date, amPm, time, user, message] = chatMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        const safeMessage = excelSafeText(message);
                        currentMessageInfo = { Timestamp: timestamp, User: user, Message: safeMessage };
                    }
                } else if (!isIgnorableLine && currentMessageInfo) {
                    currentMessageInfo.Message += '\n' + trimmedLine;
                }
            }
            if (currentMessageInfo) chatData.push(currentMessageInfo);
            return chatData;
        }
        
        function convertToCSV(data) {
            if (!data || data.length === 0) return "";
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => {
                    let cell = row[header];
                    if (cell instanceof Date) cell = cell.toISOString();
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('\n') || cell.includes('"'))) {
                        cell = `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }
    </script>
</body>
</html>
