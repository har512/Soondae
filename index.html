<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¬ê¸°ë¡œìš´ ìˆœëŒ€ìƒí™œ ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.8/dist/web/static/pretendard.css">
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        /* ê°„ë‹¨í•œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .result-item {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .summary-content {
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆì„ ì¸ì‹í•˜ë„ë¡ ì„¤ì • */
            word-break: keep-all;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg text-center">
        <h1 class="text-2xl font-bold mb-2 text-gray-800">ìŠ¬ê¸°ë¡œìš´ ìˆœëŒ€ìƒí™œ ë¶„ì„ê¸°</h1>
        <p class="text-gray-500 mb-6">ë‚´ë³´ë‚´ê¸°í•œ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”(.txt) íŒŒì¼ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
        
        <label for="fileInput" class="w-full cursor-pointer bg-yellow-300 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-yellow-400 transition-colors duration-300 inline-block">
            ğŸ“‚ íŒŒì¼ ì„ íƒí•˜ê¸°
        </label>
        <input type="file" id="fileInput" accept=".txt" class="hidden">
        <p id="fileName" class="text-sm text-gray-600 mt-3 h-5"></p>

        <div class="mt-6 text-left border-t pt-4">
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
            <div class="relative">
                <input type="password" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 pr-10" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”">
                <button id="toggleApiKey" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                    <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.816 1.201-2.085 2.224-3.655 2.893C9.879 11.832 8.12 12.5 6 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.133 13.133 0 0 1 1.172 8z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                    </svg>
                    <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash hidden" viewBox="0 0 16 16">
                        <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.94 5.94 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                        <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.288.822.822.084.083a3.5 3.5 0 0 1-4.474-4.474l.823.823.084.083a2.5 2.5 0 0 0 2.829 2.829z"/>
                        <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 6.854-12-12 .708-.708 12 12-.708.708z"/>
                    </svg>
                </button>
            </div>
            <button id="saveApiKeyBtn" class="w-full mt-2 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                API í‚¤ ì €ì¥
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
            <button id="analyzeDailyBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ì˜¤ëŠ˜ì˜ ë¸Œë¦¬í•‘
            </button>
            <button id="analyzeWeeklyBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ì§€ë‚œ 7ì¼ê°„ ìˆœìœ„
            </button>
            <button id="analyzeMonthlyStatusBtn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                ë” ì¹œí•´ì ¸ìš”
            </button>
            <button id="downloadBtn" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition-colors duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                CSV ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
        
        <div id="message" class="mt-4 text-sm h-5"></div>

        <div class="mt-6 text-left border-t pt-4">
            <div class="flex gap-2">
                <input type="text" id="userInput" class="w-2/5 p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
                <button id="personalReportBtn" class="flex-grow bg-pink-300 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-400 disabled:bg-gray-300 disabled:cursor-not-allowed whitespace-nowrap">ì´ì‚¬ëŒì´ ê¶ê¸ˆí•´</button>
            </div>
            <p id="userSearchFeedback" class="text-sm text-gray-600 mt-1 h-5"></p>
        </div>
        
        <!-- Keyword Search Section -->
        <div class="mt-4 text-left border-t pt-4">
            <div class="flex gap-2">
                <input type="text" id="keywordInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="í‚¤ì›Œë“œ ì…ë ¥">
                <select id="genderFilter" class="p-2 border border-gray-300 rounded-lg bg-white">
                    <option value="ì „ì²´">ì „ì²´</option>
                    <option value="ë‚¨">ë‚¨</option>
                    <option value="ì—¬">ì—¬</option>
                </select>
                <button id="keywordSearchBtn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 disabled:bg-gray-300 disabled:cursor-not-allowed whitespace-nowrap">ëˆ„ê°€ ê´€ì‹¬ìˆì„ê¹Œ?</button>
            </div>
            <p id="keywordSearchFeedback" class="text-sm text-gray-600 mt-1 h-5"></p>
        </div>

        <div id="analysisResult" class="mt-6 text-left"></div>
        <div id="keywordSearchResult" class="mt-6 text-left"></div>

    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let parsedChatData = [];
        let fullParsedChatData = []; // ì „ì²´ ëŒ€í™” ê¸°ë¡ ì €ì¥ìš©
        let csvContent = '';
        let timelineChartInstance = null; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ìš©

        // --- DOM ìš”ì†Œ ---
        const fileInput = document.getElementById('fileInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const analyzeDailyBtn = document.getElementById('analyzeDailyBtn');
        const analyzeWeeklyBtn = document.getElementById('analyzeWeeklyBtn');
        const analyzeMonthlyStatusBtn = document.getElementById('analyzeMonthlyStatusBtn');
        const fileNameEl = document.getElementById('fileName');
        const messageEl = document.getElementById('message');
        const analysisResultEl = document.getElementById('analysisResult');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const toggleApiKeyBtn = document.getElementById('toggleApiKey');
        const eyeOpenIcon = document.getElementById('eye-icon-open');
        const eyeClosedIcon = document.getElementById('eye-icon-closed');
        const userInput = document.getElementById('userInput');
        const personalReportBtn = document.getElementById('personalReportBtn');
        const userSearchFeedback = document.getElementById('userSearchFeedback');
        // Keyword Search elements
        const keywordInput = document.getElementById('keywordInput');
        const genderFilter = document.getElementById('genderFilter');
        const keywordSearchBtn = document.getElementById('keywordSearchBtn');
        const keywordSearchFeedback = document.getElementById('keywordSearchFeedback');
        const keywordSearchResultEl = document.getElementById('keywordSearchResult');

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', loadApiKey);

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        fileInput.addEventListener('change', handleFileSelect);
        downloadBtn.addEventListener('click', handleDownload);
        analyzeDailyBtn.addEventListener('click', handleDailyBriefing);
        analyzeWeeklyBtn.addEventListener('click', handleWeeklyAnalysis);
        analyzeMonthlyStatusBtn.addEventListener('click', handleMonthlyStatus);
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        toggleApiKeyBtn.addEventListener('click', toggleApiKeyVisibility);
        personalReportBtn.addEventListener('click', handlePersonalReport);
        keywordSearchBtn.addEventListener('click', handleKeywordSearch);

        // --- í•¨ìˆ˜ ì •ì˜ ---

        function loadApiKey() {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                messageEl.textContent = 'âœ… API í‚¤ê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                messageEl.className = 'mt-4 text-sm h-5 text-green-600';
            } else {
                localStorage.removeItem('geminiApiKey');
                messageEl.textContent = 'âš ï¸ API í‚¤ê°€ ë¹„ì–´ìˆì–´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                messageEl.className = 'mt-4 text-sm h-5 text-red-600';
            }
        }

        function toggleApiKeyVisibility() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            eyeOpenIcon.classList.toggle('hidden', isPassword);
            eyeClosedIcon.classList.toggle('hidden', !isPassword);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                resetUI();
                return;
            }
            fileNameEl.textContent = file.name;
            resetUI(false);
            messageEl.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘...';
            messageEl.className = 'mt-4 text-sm h-5 text-blue-600';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    fullParsedChatData = parseKakaoTalkLogExcelSafe(e.target.result);
                    
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    sevenDaysAgo.setHours(0, 0, 0, 0);
                    
                    parsedChatData = fullParsedChatData.filter(chat => new Date(chat.Timestamp) >= sevenDaysAgo);

                    if (fullParsedChatData.length > 0) {
                        csvContent = convertToCSV(fullParsedChatData);
                        downloadBtn.disabled = false;
                        analyzeDailyBtn.disabled = false;
                        analyzeWeeklyBtn.disabled = false;
                        analyzeMonthlyStatusBtn.disabled = false;
                        personalReportBtn.disabled = false;
                        keywordSearchBtn.disabled = false; // Enable keyword search
                        messageEl.textContent = `ğŸ‰ ì´ ${fullParsedChatData.length}ê°œ ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ! (ë¶„ì„ì€ ìµœê·¼ 7ì¼ ê¸°ì¤€)`;
                        messageEl.className = 'mt-4 text-sm h-5 text-green-600';
                    } else {
                        throw new Error("ë¶„ì„í•  ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                } catch (err) {
                    resetUI(false);
                    messageEl.textContent = `âš ï¸ ì˜¤ë¥˜: ${err.message}`;
                    messageEl.className = 'mt-4 text-sm h-5 text-red-600';
                }
            };
            reader.onerror = () => {
                resetUI();
                messageEl.textContent = 'âš ï¸ íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                messageEl.className = 'mt-4 text-sm h-5 text-red-600';
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        async function handlePersonalReport() {
            const searchTerm = userInput.value.trim();
            if (!searchTerm) {
                userSearchFeedback.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            const allUsers = [...new Set(fullParsedChatData.map(chat => chat.User).filter(user => user !== 'ì‹œìŠ¤í…œ' && user !== 'ê´€ë¦¬ì'))];
            const matchedUsers = allUsers.filter(user => user.startsWith(searchTerm));

            if (matchedUsers.length === 0) {
                userSearchFeedback.textContent = 'í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                analysisResultEl.innerHTML = '';
                return;
            }
            if (matchedUsers.length > 1) {
                userSearchFeedback.textContent = 'ì—¬ëŸ¬ ëª…ì´ ê²€ìƒ‰ë©ë‹ˆë‹¤. ë” ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                analysisResultEl.innerHTML = '';
                return;
            }

            const targetUser = matchedUsers[0];
            userSearchFeedback.textContent = `âœ… '${targetUser}' ë‹˜ì˜ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...`;
            analysisResultEl.innerHTML = '<p class="text-center">ë¦¬í¬íŠ¸ ìƒì„± ì¤‘... ğŸ¤–</p>';
            keywordSearchResultEl.innerHTML = ''; // Clear keyword results

            try {
                // 1. ì „ì²´ ëŒ€í™” ê¸°ë°˜ ë¦¬í¬íŠ¸ ìƒì„±
                const userMessages = fullParsedChatData.filter(chat => chat.User === targetUser);
                const responders = {};
                for (let i = 0; i < fullParsedChatData.length; i++) {
                    if (fullParsedChatData[i].User === targetUser) {
                        for (let j = 1; j <= 3; j++) {
                            if (i + j < fullParsedChatData.length) {
                                const nextChat = fullParsedChatData[i + j];
                                if (nextChat.User !== targetUser && nextChat.User !== 'ì‹œìŠ¤í…œ' && nextChat.User !== 'ê´€ë¦¬ì') {
                                    responders[nextChat.User] = (responders[nextChat.User] || 0) + 1;
                                    break; 
                                }
                            }
                        }
                    }
                }
                const topResponders = Object.entries(responders).sort((a, b) => b[1] - a[1]).slice(0, 3).map(item => item[0]);
                const report = await generatePersonalReport(targetUser, userMessages, topResponders);
                displayPersonalReport(targetUser, report);

                // 2. ìµœê·¼ 7ì¼ê°„ ëŒ€í™” ê¸°ë°˜ ë¦¬í¬íŠ¸ ìƒì„± ë° ì¶”ê°€
                const recentUserMessages = parsedChatData.filter(chat => chat.User === targetUser);
                
                const recentTopicsContainer = document.createElement('div');
                recentTopicsContainer.id = 'recent-topics-container';
                recentTopicsContainer.innerHTML = `<p class="text-center mt-6">ìµœê·¼ 7ì¼ê°„ í† í”½ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³</p>`;
                analysisResultEl.appendChild(recentTopicsContainer);

                if (recentUserMessages.length > 0) {
                    const recentTopicsReport = await generateRecentTopicsReport(targetUser, recentUserMessages);
                    displayRecentTopicsReport(recentTopicsReport, recentTopicsContainer);
                } else {
                    recentTopicsContainer.innerHTML = ''; 
                }

            } catch (error) {
                analysisResultEl.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }
        
        // --- Keyword Search Functions ---
        
        async function handleKeywordSearch() {
            const keyword = keywordInput.value.trim();
            if (!keyword) {
                keywordSearchFeedback.textContent = 'í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            if (fullParsedChatData.length === 0) {
                 keywordSearchFeedback.textContent = 'ë¨¼ì € íŒŒì¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.';
                 return;
            }

            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                keywordSearchFeedback.textContent = 'âš ï¸ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.';
                keywordSearchResultEl.innerHTML = '<p class="text-red-500 text-center p-4">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                analysisResultEl.innerHTML = ''; 
                return;
            }

            keywordSearchFeedback.textContent = `ğŸ” '${keyword}'ì— ê´€ì‹¬ìˆëŠ” ì‚¬ëŒì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...`;
            keywordSearchResultEl.innerHTML = '<div class="text-center p-4">ë¶„ì„ ì¤‘... ğŸ¤–</div>';
            analysisResultEl.innerHTML = ''; // Clear other results

            try {
                const relevantMessagesByUser = fullParsedChatData.reduce((acc, chat) => {
                    if (chat.Message.toLowerCase().includes(keyword.toLowerCase()) && chat.User !== 'ì‹œìŠ¤í…œ' && chat.User !== 'ê´€ë¦¬ì') {
                        if (!acc[chat.User]) {
                            acc[chat.User] = [];
                        }
                        acc[chat.User].push(chat.Message);
                    }
                    return acc;
                }, {});

                let users = Object.keys(relevantMessagesByUser);
                const gender = genderFilter.value;

                if (gender !== 'ì „ì²´') {
                    users = users.filter(user => {
                        const parts = user.split('/');
                        return parts.length > 1 && parts[1] === gender;
                    });
                }

                if (users.length === 0) {
                    keywordSearchResultEl.innerHTML = `<p class='text-center text-gray-500 p-4'>'${keyword}'ì— ëŒ€í•œ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    keywordSearchFeedback.textContent = 'âœ… ê²€ìƒ‰ ì™„ë£Œ';
                    return;
                }
                
                const results = [];
                for (const user of users) {
                    const userMessages = relevantMessagesByUser[user];
                    try {
                        const result = await generateKeywordSummary(user, keyword, userMessages);
                        results.push({ user, ...result });
                    } catch (error) {
                        console.error(`Error generating summary for ${user}:`, error);
                        results.push({ user, summary: error.message || "ìš”ì•½ ìƒì„± ì‹¤íŒ¨", relevance: 0 });
                    }
                }

                results.sort((a, b) => b.relevance - a.relevance);

                displayKeywordSearchResults(keyword, results);
                keywordSearchFeedback.textContent = 'âœ… ê²€ìƒ‰ ì™„ë£Œ';

            } catch (error) {
                keywordSearchResultEl.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
                keywordSearchFeedback.textContent = 'âš ï¸ ì˜¤ë¥˜ ë°œìƒ';
            }
        }
        
        async function generateKeywordSummary(user, keyword, messages) {
            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

            const prompt = `
                '${user}'ë‹˜ì˜ ëŒ€í™”ì—ì„œ '${keyword}'ë¼ëŠ” í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë‚´ìš©ì…ë‹ˆë‹¤.
                ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, '${user}'ë‹˜ì´ '${keyword}'ì— ëŒ€í•´ ì–´ë–¤ ë§¥ë½ì—ì„œ ì´ì•¼ê¸°í–ˆëŠ”ì§€, ì–´ë–¤ ê´€ì‹¬ì´ë‚˜ ê´€ë ¨ì´ ìˆëŠ”ì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§¤ìš° ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.
                ê·¸ë¦¬ê³  '${keyword}'ì™€ì˜ ê´€ë ¨ì„±ì„ 1~10 ì‚¬ì´ì˜ ì ìˆ˜ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.
                
                **ì°¸ê³  ëŒ€í™” ë‚´ìš©:**
                ---
                ${messages.join('\n').substring(0, 3000)}
                ---

                **ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSON í˜•ì‹ ì¤€ìˆ˜, ë‹¤ë¥¸ ì„¤ëª…ì€ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”):**
                {
                  "summary": "[ìš”ì•½ ë‚´ìš©]",
                  "relevance": [1-10 ì‚¬ì´ì˜ ê´€ë ¨ì„± ì ìˆ˜(ìˆ«ì)]
                }
            `;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                 try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                            try {
                                const rawText = result.candidates[0].content.parts[0].text;
                                const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                                return JSON.parse(jsonText);
                            } catch (e) {
                                console.error("Failed to parse JSON from API response:", e, rawText);
                                return { summary: "ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", relevance: 0 };
                            }
                        } else {
                            return { summary: "ê´€ë ¨ ë‚´ìš©ì„ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", relevance: 0 };
                        }
                    }

                    if (response.status === 429) {
                        throw new Error('Rate limited');
                    } else {
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                    }

                } catch (error) {
                    if (error.message === 'Rate limited') {
                        retries--;
                        if (retries === 0) {
                            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: 429 (ìš”ì²­ í•œë„ ì´ˆê³¼)`);
                        }
                        console.log(`Rate limited for ${user}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        function displayKeywordSearchResults(keyword, results) {
            keywordSearchResultEl.innerHTML = '';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-gray-800 border-b pb-2';
            title.textContent = `ğŸ” '${keyword}' í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ (ê´€ë ¨ì„± ë†’ì€ ìˆœ)`;
            keywordSearchResultEl.appendChild(title);

            if (results.length === 0) {
                const noData = document.createElement('p');
                noData.className = 'text-gray-500 mt-4';
                noData.textContent = `ì¡°ê±´ì— ë§ëŠ” ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                keywordSearchResultEl.appendChild(noData);
                return;
            }

            const list = document.createElement('ul');
            list.className = 'space-y-2';
            results.forEach((result, index) => {
                const item = document.createElement('li');
                item.className = 'result-item p-3 rounded-lg bg-gray-50 text-left';
                item.style.animationDelay = `${index * 100}ms`;
                item.innerHTML = `
                    <div class="flex items-start">
                        <span class="mr-2 px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">${result.relevance}</span>
                        <p>
                            <span class="font-bold text-teal-700">${result.user}</span>:
                            <span class="text-gray-600 ml-1">${result.summary}</span>
                        </p>
                    </div>
                `;
                list.appendChild(item);
            });
            keywordSearchResultEl.appendChild(list);
        }

        // --- End of Keyword Search Functions ---

        async function generatePersonalReport(targetUser, userMessages, topResponders) {
            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                throw new Error("Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
            }

            const prompt = `
                '${targetUser}' ë‹˜ì˜ ì „ì²´ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ê¸°ë¡ì„ ë¶„ì„í•´ì„œ ì•„ë˜ í˜•ì‹ì— ë§ì¶° ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.
                
                **ë¶„ì„í•  ë‚´ìš©:**
                1. ì´ ëŒ€í™” íšŸìˆ˜: ${userMessages.length}íšŒ
                2. ì£¼ìš” ëŒ€í™” ì£¼ì œ: ì•„ë˜ ëŒ€í™” ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•µì‹¬ ì£¼ì œë¥¼ 3ê°€ì§€ ì •ë„ë¡œ ì¬ë¯¸ìˆê³  êµ¬ì²´ì ìœ¼ë¡œ ìš”ì•½í•´ì¤˜.
                3. ì¹œí•œì¹œêµ¬ ë¶„ì„: ì´ ì‚¬ëŒì˜ ë§ì— ê°€ì¥ ë§ì´ ë°˜ì‘í•œ ìƒìœ„ 3ëª…ì€ ë‹¤ìŒê³¼ ê°™ì•„: ${topResponders.join(', ')}. ì´ ì‚¬ì‹¤ì„ ë°”íƒ•ìœ¼ë¡œ ìƒí˜¸ì‘ìš©ì— ëŒ€í•´ ì¬ë°Œìˆê²Œ ì½”ë©˜íŠ¸í•´ì¤˜.

                **ì°¸ê³  ëŒ€í™” ë‚´ìš©:**
                ---
                ${userMessages.map(m => m.Message).join('\n').substring(0, 4000)}
                ---

                **ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ì— ë§ì¶°ì„œ ì‘ì„±):**
                ### ğŸ’¬ ì´ ëŒ€í™” íšŸìˆ˜
                - ì´ ${userMessages.length}íšŒ ëŒ€í™”ì— ì°¸ì—¬í–ˆì–´ìš”.

                ### ğŸ“œ ì£¼ìš” ëŒ€í™” ì£¼ì œ
                - [ì£¼ì œ 1 ì œëª©]
                [ì£¼ì œ 1 ìš”ì•½]

                - [ì£¼ì œ 2 ì œëª©]
                [ì£¼ì œ 2 ìš”ì•½]
                
                - [ì£¼ì œ 3 ì œëª©]
                [ì£¼ì œ 3 ìš”ì•½]

                ### ğŸ™‹â€â™‚ï¸ ì¹œí•œì¹œêµ¬ ë¶„ì„
                - [ìƒí˜¸ì‘ìš©ì— ëŒ€í•œ ì¬ë¯¸ìˆëŠ” ì½”ë©˜íŠ¸]
            `;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function displayPersonalReport(targetUser, report) {
            analysisResultEl.innerHTML = '';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-gray-800 border-b pb-2';
            title.textContent = `ğŸ“Š ${targetUser}ë‹˜ ê°œì¸ ë¦¬í¬íŠ¸ (ì „ì²´)`;
            
            const content = document.createElement('div');
            content.className = 'summary-content text-left';
            content.innerHTML = report.replace(/### (.*)/g, '<h3 class="text-lg font-bold mt-4 mb-2 text-gray-700">$1</h3>')
                                      .replace(/^- (.*)/gm, '<p class="ml-2">- $1</p>');
            
            analysisResultEl.appendChild(title);
            analysisResultEl.appendChild(content);
        }

        async function generateRecentTopicsReport(targetUser, recentUserMessages) {
            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                throw new Error("Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
            }

            const prompt = `
                '${targetUser}' ë‹˜ì˜ ìµœê·¼ 7ì¼ê°„ì˜ ëŒ€í™” ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìµœê·¼ ì£¼ìš” ê´€ì‹¬ì‚¬ì™€ ëŒ€í™” ì£¼ì œê°€ ë¬´ì—‡ì¸ì§€ 1~2ê°œ ì •ë„ ì¬ë¯¸ìˆê³  êµ¬ì²´ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

                **ì°¸ê³  ëŒ€í™” ë‚´ìš© (ìµœê·¼ 7ì¼):**
                ---
                ${recentUserMessages.map(m => m.Message).join('\n').substring(0, 4000)}
                ---

                **ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ì— ë§ì¶°ì„œ ì‘ì„±):**
                - [ìµœê·¼ ì£¼ì œ 1 ì œëª©]
                [ìµœê·¼ ì£¼ì œ 1 ìš”ì•½]

                - [ìµœê·¼ ì£¼ì œ 2 ì œëª©]
                [ìµœê·¼ ì£¼ì œ 2 ìš”ì•½]
            `;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function displayRecentTopicsReport(report, container) {
            container.innerHTML = '';

            const divider = document.createElement('hr');
            divider.className = 'my-6 border-t border-gray-200';
            
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-gray-800 border-b pb-2';
            title.textContent = `â±ï¸ ${userInput.value.trim()}ë‹˜ ìµœê·¼ 7ì¼ê°„ í† í”½`;
            
            const content = document.createElement('div');
            content.className = 'summary-content text-left';
            content.innerHTML = report.replace(/^- (.*)/gm, '<p class="ml-2">- $1</p>');
            
            container.appendChild(divider);
            container.appendChild(title);
            container.appendChild(content);
        }


        async function handleDailyBriefing() {
            if (fullParsedChatData.length === 0) return;
            
            keywordSearchResultEl.innerHTML = ''; // Clear keyword results
            
            let chatsForRanking = [];
            let analysisDate = null;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaysChats = fullParsedChatData.filter(chat => {
                const chatDate = new Date(chat.Timestamp);
                chatDate.setHours(0, 0, 0, 0);
                return chatDate.getTime() === today.getTime();
            });

            if (todaysChats.length > 0) {
                chatsForRanking = todaysChats;
                analysisDate = today;
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);
                const yesterdaysChats = fullParsedChatData.filter(chat => {
                    const chatDate = new Date(chat.Timestamp);
                    chatDate.setHours(0, 0, 0, 0);
                    return chatDate.getTime() === yesterday.getTime();
                });
                if (yesterdaysChats.length > 0) {
                    chatsForRanking = yesterdaysChats;
                    analysisDate = yesterday;
                }
            }
            
            const userCounts = countUserMessages(chatsForRanking);
            const top5 = getTopUsers(userCounts);

            // 1. ìˆœìœ„ í‘œì‹œ í•¨ìˆ˜ë¥¼ ë¨¼ì € í˜¸ì¶œí•˜ì—¬ ê¸°ë³¸ êµ¬ì¡°(ì°¨íŠ¸ ìº”ë²„ìŠ¤, ìˆœìœ„ ì œëª© ë“±) ìƒì„±
            displayAnalysisResult(top5, null, true, analysisDate);

            // 2. ì§€ë‚œ 24ì‹œê°„ ë°ì´í„°ë¡œ ì°¨íŠ¸ ìƒì„± ë° í‘œì‹œ
            const twentyFourHoursAgo = new Date();
            twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
            const last24hChats = fullParsedChatData.filter(chat => new Date(chat.Timestamp) >= twentyFourHoursAgo);
            
            const chartData = generateTimelineData(last24hChats);
            displayTimelineChart(chartData);

            // 3. HOT TIME í† í”½ ìƒì„± ë° í‘œì‹œ
            await displayHotTimeTopics(last24hChats, chartData);

            // 4. ì¸ì› ë³€ë™ í‘œì‹œ
            displayMemberChanges(chatsForRanking);

            // 5. ê°œì¸ë³„ ìš”ì•½ ìƒì„±
            for (const [user, count] of top5) {
                const userChats = last24hChats
                    .filter(chat => chat.User === user)
                    .map(chat => chat.Message)
                    .join('\n');
                
                const summaryElement = document.getElementById(`summary-for-${user.replace(/\s/g, '-')}`);
                if (summaryElement) {
                    if (userChats.length > 0) {
                        try {
                            const summary = await generateSummary(user, userChats);
                            summaryElement.innerHTML = `<p class="summary-content">${summary}</p>`;
                            await new Promise(res => setTimeout(res, 1000)); // 1ì´ˆ ë”œë ˆì´ ì¶”ê°€
                        } catch (error) {
                            summaryElement.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                        }
                    } else {
                        summaryElement.innerHTML = `<p class="text-gray-500">ì§€ë‚œ 24ì‹œê°„ ëŒ€í™” ì—†ìŒ</p>`;
                    }
                }
            }
        }

        async function generateSummary(userName, userChats) {
            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                throw new Error("Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
            }
            
            const prompt = `${userName}ë‹˜ì˜ ìµœê·¼ ëŒ€í™” ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ëŒ€í™” ì£¼ì œê°€ ë­ì˜€ëŠ”ì§€ ì´ëª¨í‹°ì½˜ì„ ì„ì–´ì„œ ìœ„íŠ¸ìˆê²Œ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”. ëŒ€í™”ë§¥ë½ì´ ë­”ì§€ ëª¨ë¥´ëŠ”ì‚¬ëŒë„ ì•Œì•„ë“¤ì„ ìˆ˜ ìˆê²Œ ì•Œë ¤ì£¼ì„¸ìš”:\n\n---\n${userChats.substring(0, 3000)}\n---`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            let retries = 3;
            let delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    retries--;
                    if (retries === 0) {
                        console.error("API call failed after multiple retries:", error);
                        throw new Error("ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš” ğŸ˜¢");
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        function handleWeeklyAnalysis() {
            if (parsedChatData.length === 0) return;
            keywordSearchResultEl.innerHTML = ''; // Clear keyword results
            const userCounts = countUserMessages(parsedChatData);
            const top20 = getTopUsers(userCounts, 20);
            displayAnalysisResult(top20, 'ì§€ë‚œ 7ì¼ê°„');
        }

        function handleMonthlyStatus() {
            if (parsedChatData.length === 0) return;
            keywordSearchResultEl.innerHTML = ''; // Clear keyword results
            const now = new Date();
            const monthlyChats = parsedChatData.filter(chat => {
                const chatDate = new Date(chat.Timestamp);
                return chatDate.getFullYear() === now.getFullYear() && chatDate.getMonth() === now.getMonth();
            });
            if (monthlyChats.length === 0) {
                displayWarningList([], 'ì´ë²ˆ ë‹¬');
                return;
            }
            const userCounts = countUserMessages(monthlyChats);
            const warningUsers = Object.entries(userCounts)
                .filter(([user, count]) => count < 50)
                .sort((a, b) => a[1] - b[1]);
            displayWarningList(warningUsers, 'ì´ë²ˆ ë‹¬');
        }
        
        function countUserMessages(chatList) {
            const userCounts = {};
            chatList.forEach(chat => {
                if (chat.User !== 'ì‹œìŠ¤í…œ' && chat.User !== 'ê´€ë¦¬ì') {
                    userCounts[chat.User] = (userCounts[chat.User] || 0) + 1;
                }
            });
            return userCounts;
        }

        function getTopUsers(userCounts, count = 5) {
            return Object.entries(userCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, count);
        }
        
        function formatDate(date) {
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
            return `${year}.${month}.${day} (${dayOfWeek})`;
        }

        function displayAnalysisResult(ranking, dateString, isBriefing = false, briefingDate = null) {
            analysisResultEl.innerHTML = '';
            
            if (isBriefing) {
                // ë©”ì¸ íƒ€ì´í‹€
                const mainTitle = document.createElement('h2');
                mainTitle.className = 'text-xl font-bold mb-4 text-gray-800';
                mainTitle.textContent = briefingDate ? `ì˜¤ëŠ˜ì˜ ìˆœëŒ€ ë¸Œë¦¬í•‘ (${formatDate(briefingDate)})` : 'ì˜¤ëŠ˜ì˜ ìˆœëŒ€ ë¸Œë¦¬í•‘';
                analysisResultEl.appendChild(mainTitle);

                // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ
                const chartContainer = document.createElement('div');
                chartContainer.className = 'mb-6';
                chartContainer.innerHTML = `
                    <h3 class="text-lg font-bold mb-2 text-gray-700">ğŸ“ˆ ì§€ë‚œ 24ì‹œê°„ ëŒ€í™”ëŸ‰ ì¶”ì´</h3>
                    <canvas id="timelineChart"></canvas>
                `;
                analysisResultEl.appendChild(chartContainer);
            }

            // ì†Œì œëª© (ëŒ€í™”ì™• ìˆœìœ„)
            const subTitle = document.createElement('h3');
            subTitle.className = 'text-lg font-bold mb-2 text-gray-700 mt-6 pt-4 border-t';
            subTitle.textContent = isBriefing ? 'ì˜¤ëŠ˜ì˜ ëŒ€í™”ì™• ğŸ‘‘' : `ğŸ‘‘ ${dateString}ì˜ ëŒ€í™”ì™• ìˆœìœ„ TOP ${ranking.length}`;
            analysisResultEl.appendChild(subTitle);


            if (ranking.length === 0) {
                const noData = document.createElement('p');
                noData.className = 'text-gray-500 mt-4';
                noData.textContent = `${briefingDate ? formatDate(briefingDate) : dateString} ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                analysisResultEl.appendChild(noData);
                if(isBriefing) {
                    const ctx = document.getElementById('timelineChart')?.getContext('2d');
                    if(ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                }
                return;
            }
            const list = document.createElement('ol');
            list.className = 'space-y-3';
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            ranking.forEach(([user, count], index) => {
                const item = document.createElement('li');
                item.className = 'result-item p-3 rounded-lg bg-gray-50 text-left';
                item.style.animationDelay = `${index * 100}ms`;
                const rank = medals[index] || `<span class="text-gray-500">${index + 1}.</span>`;
                const summaryHtml = isBriefing ?
                    `<div id="summary-for-${user.replace(/\s/g, '-')}" class="mt-2 text-sm text-gray-600 p-2 bg-gray-100 rounded">ìš”ì•½ ì¤‘... ğŸ¤”</div>` : '';
                
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="font-bold w-10 text-lg text-center">${rank}</span>
                            <span class="text-gray-700">${user}</span>
                        </div>
                        <span class="font-semibold text-blue-600">${count}íšŒ</span>
                    </div>
                    ${summaryHtml}
                `;
                list.appendChild(item);
            });
            analysisResultEl.appendChild(list);
        }

        function generateTimelineData(chats) {
            const now = new Date();
            const labels = [];
            const data = new Array(48).fill(0); // 24 hours * 2 intervals/hour

            const startOfCurrentInterval = new Date(now);
            const currentMinutes = startOfCurrentInterval.getMinutes();
            if (currentMinutes < 30) {
                startOfCurrentInterval.setMinutes(0, 0, 0);
            } else {
                startOfCurrentInterval.setMinutes(30, 0, 0);
            }
            
            const startTime = new Date(startOfCurrentInterval.getTime() - 47 * 30 * 60 * 1000);

            for (let i = 0; i < 48; i++) {
                const time = new Date(startTime.getTime() + i * 30 * 60 * 1000);
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                labels.push(`${hours}:${minutes}`);
            }

            chats.forEach(chat => {
                const chatTime = new Date(chat.Timestamp);
                const diffMinutes = (chatTime - startTime) / (1000 * 60);
                const index = Math.floor(diffMinutes / 30);

                if (index >= 0 && index < 48) {
                    data[index]++;
                }
            });

            return { labels, data };
        }

        function displayTimelineChart({ labels, data }) {
            const ctx = document.getElementById('timelineChart')?.getContext('2d');
            if (!ctx) return;

            if (timelineChartInstance) {
                timelineChartInstance.destroy();
            }

            timelineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ëŒ€í™” ìˆ˜',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0, 
                        pointHoverRadius: 5,
                        pointHitRadius: 10,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `â° ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    return `ğŸ’¬ ëŒ€í™”: ${context.parsed.y}íšŒ`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            });
        }

        async function displayHotTimeTopics(chats, timelineData) {
            const hotTimeContainer = document.createElement('div');
            hotTimeContainer.className = 'my-6 pt-4 border-t';
            hotTimeContainer.innerHTML = '<h3 class="text-lg font-bold mb-2 text-gray-700">ğŸ”¥ HOT TIME í† í”½ TOP 2</h3>';
            
            const rankingTitle = Array.from(analysisResultEl.querySelectorAll('h3')).pop();
            if (rankingTitle) {
                analysisResultEl.insertBefore(hotTimeContainer, rankingTitle);
            } else {
                analysisResultEl.appendChild(hotTimeContainer);
            }

            const topSlots = timelineData.data
                .map((count, index) => ({ count, index }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 2)
                .filter(slot => slot.count > 0);

            if (topSlots.length === 0) {
                hotTimeContainer.innerHTML += '<p class="text-gray-500 text-sm">ì§€ë‚œ 24ì‹œê°„ ë™ì•ˆ ëŒ€í™”ê°€ ì—†ì–´ HOT TIMEì„ ë¶„ì„í•  ìˆ˜ ì—†ì–´ìš”.</p>';
                return;
            }

            const now = new Date();
            const startOfCurrentInterval = new Date(now);
            const currentMinutes = startOfCurrentInterval.getMinutes();
            if (currentMinutes < 30) {
                startOfCurrentInterval.setMinutes(0, 0, 0);
            } else {
                startOfCurrentInterval.setMinutes(30, 0, 0);
            }
            const startTime = new Date(startOfCurrentInterval.getTime() - 47 * 30 * 60 * 1000);

            for (const slot of topSlots) {
                const originalSlotStartTime = new Date(startTime.getTime() + slot.index * 30 * 60 * 1000);
                const slotStartTime = new Date(originalSlotStartTime.getTime() - 30 * 60 * 1000);
                const slotEndTime = new Date(originalSlotStartTime.getTime() + 60 * 60 * 1000);
                
                const formatTime = (date) => `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                const timeLabel = `${formatTime(slotStartTime)} ~ ${formatTime(slotEndTime)}`;

                const slotMessages = chats.filter(chat => {
                    const chatTime = new Date(chat.Timestamp);
                    return chatTime >= slotStartTime && chatTime < slotEndTime;
                });
                
                const messageCountInWindow = slotMessages.length;

                const topicElement = document.createElement('div');
                topicElement.className = 'mt-3 p-3 rounded-lg bg-yellow-50 text-left';
                topicElement.innerHTML = `
                    <p class="font-bold text-gray-800">â° ${timeLabel} (ëŒ€í™” ${messageCountInWindow}íšŒ)</p>
                    <div class="summary-content text-sm text-gray-600 mt-1" id="hot-topic-${slot.index}">ìš”ì•½ ì¤‘... ğŸ¤”</div>
                `;
                hotTimeContainer.appendChild(topicElement);

                generateHotTimeSummary(slotMessages).then(summary => {
                    const summaryEl = document.getElementById(`hot-topic-${slot.index}`);
                    if (summaryEl) summaryEl.innerHTML = summary;
                }).catch(error => {
                    const summaryEl = document.getElementById(`hot-topic-${slot.index}`);
                    if (summaryEl) summaryEl.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                });
            }
        }

        async function generateHotTimeSummary(messages) {
            const apiKey = apiKeyInput.value.trim() || localStorage.getItem('geminiApiKey');
            if (!apiKey) throw new Error("Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");

            const chatContent = messages.map(m => `${m.User}: ${m.Message}`).join('\n');
            if (!chatContent) return "íŠ¹ë³„í•œ ì£¼ì œ ì—†ì´ ëŒ€í™”ê°€ ì˜¤ê³  ê°”ì–´ìš”.";

            const prompt = `ë‹¤ìŒì€ íŠ¹ì • ì‹œê°„ëŒ€ì— ë‚˜ëˆˆ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë‚´ìš©ì´ì•¼. ì´ ëŒ€í™”ì˜ í•µì‹¬ ë‚´ìš©ì„ ì•„ë˜ ì¡°ê±´ì— ë§ì¶°ì„œ ìš”ì•½í•´ì¤˜.

            ì¡°ê±´:
            1. ìˆ«ì ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„± (ì˜ˆ: 1. ë‚´ìš©)
            2. ê° í•­ëª©ì€ ì´ëª¨í‹°ì½˜ ì—†ì´, ìµœëŒ€ 13ê¸€ìë¡œ ì‘ì„±
            3. ìµœëŒ€ 9ê°œ í•­ëª©ê¹Œì§€ë§Œ ìš”ì•½
            4. 9ê°œ í•­ëª©ì„ ë‹¤ ì±„ìš°ì§€ ëª»í•´ë„, ë§ˆì§€ë§‰ì—ëŠ” ë°˜ë“œì‹œ "10. ë§ë‹¤.."ë¥¼ ì¶”ê°€í•  ê²ƒ
            5. ëŒ€í™” ë‚´ìš©ì´ ê±°ì˜ ì—†ë‹¤ë©´ "1. ì¡°ìš©í•œ ì‹œê°„ì´ì—ˆë„¤ìš”." ì •ë„ë¡œë§Œ ìš”ì•½í•˜ê³  "10. ë§ë‹¤.."ëŠ” ìƒëµí•  ê²ƒ

            ì¶œë ¥ ì˜ˆì‹œ:
            1. ì‹ ì…ë¶„ë“¤ í™˜ì˜í•˜ê³  ë°˜ê°‘ìŠµë‹ˆë‹¤.
            2. ì•ˆì–‘ì²œ ë²™ê°œ ë§ê´€ë¶€
            3. ì²´ë¦¬ vs ìƒˆë¡œ ì‚¬ë‘ì‹¸ì›€
            4. ìœ„ê³ ë¹„ ëŒ€í•­ë§ˆ ë“±ì¥
            5. ì²´ë¦¬ë‹˜ ìƒì¼ ì¶•í•˜
            6.
            7.
            8.
            9.
            10. ë§ë‹¤..
            
            ---
            [ëŒ€í™” ë‚´ìš©]
            ${chatContent.substring(0, 3000)}
            ---`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš” ğŸ˜¢");
            }
        }

        function displayMemberChanges(chatList) {
            const newMembers = [];
            const leftMembers = [];

            const systemMessages = chatList.filter(chat => chat.User === 'ì‹œìŠ¤í…œ');
            systemMessages.forEach(chat => {
                if (chat.Message.includes('ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤')) {
                    newMembers.push(chat.Message.split('ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤')[0]);
                } else if (chat.Message.includes('ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤')) {
                    leftMembers.push(chat.Message.split('ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤')[0]);
                }
            });

            const noticeSection = document.createElement('div');
            noticeSection.id = 'notice-section';
            noticeSection.className = 'mt-6 pt-4 border-t';
            
            const title = document.createElement('h3');
            title.className = 'text-lg font-bold mb-2 text-gray-700';
            title.textContent = 'ğŸ  ìˆœëŒ€ ë™ì‚¬ë¬´ì†Œ ì•Œë¦¼';
            noticeSection.appendChild(title);

            let noticeContent = '';
            if (newMembers.length === 0 && leftMembers.length === 0) {
                noticeContent += `<p class="text-gray-500 text-sm">ì˜¤ëŠ˜ì€ ì¸ì› ë³€ë™ì´ ì—†ì–´ìš”!</p>`;
            } else {
                if (newMembers.length > 0) {
                    noticeContent += `<p class="text-green-600 text-sm">ğŸ‰ ìƒˆë¡œ ì „ì…ì™”ì–´ìš”!</p>`;
                    newMembers.forEach(name => {
                        noticeContent += `<p class="text-green-600 text-sm pl-4">- ${name}</p>`;
                    });
                }
                if (leftMembers.length > 0) {
                    noticeContent += `<p class="text-red-600 text-sm mt-2">ğŸ˜¢ ì „ì¶œê°€ì…¨ì–´ìš”.</p>`;
                    leftMembers.forEach(name => {
                        noticeContent += `<p class="text-red-600 text-sm pl-4">- ${name}</p>`;
                    });
                }
            }
            noticeSection.innerHTML += noticeContent;
            
            const shareButtonContainer = document.createElement('div');
            shareButtonContainer.className = 'mt-6 flex gap-2 justify-center';

            const shareTextButton = document.createElement('button');
            shareTextButton.className = 'flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors';
            shareTextButton.textContent = 'ë¸Œë¦¬í•‘ í…ìŠ¤íŠ¸ ë³µì‚¬';
            shareTextButton.onclick = handleShareText;

            const shareImageButton = document.createElement('button');
            shareImageButton.className = 'flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors';
            shareImageButton.textContent = 'ì°¨íŠ¸ ì´ë¯¸ì§€ ë³µì‚¬';
            shareImageButton.onclick = handleShareImage;
            
            shareButtonContainer.appendChild(shareTextButton);
            shareButtonContainer.appendChild(shareImageButton);

            analysisResultEl.appendChild(noticeSection);
            analysisResultEl.appendChild(shareButtonContainer);
        }
        
        function generateBriefingText() {
            const briefingContent = [];
            const mainTitle = analysisResultEl.querySelector('h2').textContent;
            briefingContent.push(`[${mainTitle}]`);

            const hotTopicsContainer = analysisResultEl.querySelector('.my-6.pt-4.border-t');
            if (hotTopicsContainer) {
                briefingContent.push(`\n---`);
                briefingContent.push(`[ğŸ”¥ HOT TIME í† í”½ TOP 2]`);
                hotTopicsContainer.querySelectorAll('.bg-yellow-50').forEach(item => {
                    const time = item.querySelector('.font-bold').textContent;
                    const summary = item.querySelector('.summary-content').textContent;
                    briefingContent.push(`\n${time}\n${summary}`);
                });
            }

            briefingContent.push('\n---');
            briefingContent.push('[ì˜¤ëŠ˜ì˜ ëŒ€í™”ì™• ğŸ‘‘]');
            const rankingList = analysisResultEl.querySelectorAll('ol > li');
            rankingList.forEach(item => {
                const rank = item.querySelector('.font-bold').textContent.trim();
                const user = item.querySelector('.text-gray-700').textContent;
                const count = item.querySelector('.font-semibold').textContent;
                const summary = item.querySelector('.summary-content')?.textContent || '(ìš”ì•½ ì—†ìŒ)';
                briefingContent.push(`\n${rank} ${user} (${count})`);
                briefingContent.push(`${summary}`);
            });

            const noticeSection = analysisResultEl.querySelector('#notice-section');
            if (noticeSection) {
                const noticeTitle = noticeSection.querySelector('h3')?.textContent;
                briefingContent.push('\n---');
                briefingContent.push(`[${noticeTitle}]`);
                const notices = noticeSection.querySelectorAll('p');
                notices.forEach(p => {
                    briefingContent.push(p.textContent);
                });
            }
            return briefingContent.join('\n');
        }

        async function generateBriefingImageBlob() {
            if (!timelineChartInstance) return null;
            
            const originalCanvas = timelineChartInstance.canvas;
            const titleText = 'ğŸ“ˆ ì§€ë‚œ 24ì‹œê°„ ëŒ€í™”ëŸ‰ ì¶”ì´';
            const titleHeight = 40;
            
            const newCanvas = document.createElement('canvas');
            newCanvas.width = originalCanvas.width;
            newCanvas.height = originalCanvas.height + titleHeight;
            const ctx = newCanvas.getContext('2d');
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            ctx.fillStyle = '#374151';
            ctx.font = `bold 18px 'Pretendard', sans-serif`;
            ctx.textBaseline = 'top';
            ctx.fillText(titleText, 10, 10);
            
            ctx.drawImage(originalCanvas, 0, titleHeight);

            return await new Promise(resolve => newCanvas.toBlob(resolve, 'image/png'));
        }

        async function handleShareText() {
            const textToCopy = generateBriefingText();
            try {
                await navigator.clipboard.writeText(textToCopy);
                messageEl.textContent = 'âœ… ë¸Œë¦¬í•‘ í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                messageEl.className = 'mt-4 text-sm h-5 text-green-600';
            } catch (err) {
                console.error('Text copy failed with navigator.clipboard, trying fallback:', err);
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    messageEl.textContent = 'âœ… í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    messageEl.className = 'mt-4 text-sm h-5 text-green-600';
                } catch (copyErr) {
                    messageEl.textContent = 'âš ï¸ í…ìŠ¤íŠ¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    messageEl.className = 'mt-4 text-sm h-5 text-red-600';
                }
                document.body.removeChild(textArea);
            }
        }

        async function handleShareImage() {
            try {
                const imageBlob = await generateBriefingImageBlob();
                if (!imageBlob) throw new Error('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': imageBlob })
                ]);

                messageEl.textContent = 'âœ… ì°¨íŠ¸ ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                messageEl.className = 'mt-4 text-sm h-5 text-green-600';
            } catch (err) {
                console.error('Image copy failed:', err);
                messageEl.textContent = 'âš ï¸ ì´ë¯¸ì§€ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë¯¸ì§€ì›)';
                messageEl.className = 'mt-4 text-sm h-5 text-red-600';
            }
        }

        function displayWarningList(warningList, dateString) {
            analysisResultEl.innerHTML = '';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold mb-3 text-red-600 border-b pb-2';
            title.textContent = `â˜•ï¸ ë” ì¹œí•´ì ¸ìš” (${dateString} 50íšŒ ë¯¸ë§Œ)`;
            analysisResultEl.appendChild(title);
            if (warningList.length === 0) {
                const allActive = document.createElement('p');
                allActive.className = 'text-gray-500 mt-4';
                allActive.textContent = `ëª¨ë“  ë©¤ë²„ê°€ 50íšŒ ì´ìƒ ëŒ€í™”í–ˆìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!`;
                analysisResultEl.appendChild(allActive);
                return;
            }
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            warningList.forEach(([user, count], index) => {
                const item = document.createElement('li');
                item.className = 'result-item flex items-center justify-between p-2 rounded-lg bg-red-50';
                item.style.animationDelay = `${index * 100}ms`;
                item.innerHTML = `
                    <span class="text-gray-700">${user}</span>
                    <span class="font-semibold text-red-600">${count}íšŒ</span>
                `;
                list.appendChild(item);
            });
            analysisResultEl.appendChild(list);
        }

        function handleDownload() {
            if (!csvContent || downloadBtn.disabled) return;
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'KakaoTalk_chat_log.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function resetUI(resetFileName = true) {
            if (resetFileName) {
                fileNameEl.textContent = '';
                fileInput.value = '';
            }
            downloadBtn.disabled = true;
            analyzeDailyBtn.disabled = true;
            analyzeWeeklyBtn.disabled = true;
            analyzeMonthlyStatusBtn.disabled = true;
            personalReportBtn.disabled = true;
            keywordSearchBtn.disabled = true; // Disable keyword search button
            messageEl.textContent = '';
            analysisResultEl.innerHTML = '';
            keywordSearchResultEl.innerHTML = ''; // Clear keyword search results
            parsedChatData = [];
            fullParsedChatData = [];
            csvContent = '';
        }

        function parseKakaoTalkLogExcelSafe(fileContent) {
            const chatData = [];
            if (!fileContent) return chatData;
            const chatPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(.*?)\s*:\s*(.*)/;
            const systemPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(.*(?:ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤)\.?)/;
            const adminPattern = /^(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼) (ì˜¤ì „|ì˜¤í›„) (\d{1,2}:\d{2}),\s*(ê´€ë¦¬ìê°€ \d+ê°œì˜ ë©”ì‹œì§€ë¥¼ ê°€ë ¸ìŠµë‹ˆë‹¤\.)/;
            const dateSeparatorPattern = /^-+\s*\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼\s.*-+$/;
            const timestampOnlyPattern = /^\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼ (ì˜¤ì „|ì˜¤í›„) \d{1,2}:\d{2}$/;
            let currentMessageInfo = null;
            const lines = fileContent.split('\n');
            const formatTimestamp = (dateStr, amPmStr, timeStr) => {
                const datePart = dateStr.match(/(\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼/);
                const year = parseInt(datePart[1], 10);
                const month = parseInt(datePart[2], 10) - 1;
                const day = parseInt(datePart[3], 10);
                let [hour, minute] = timeStr.split(':').map(num => parseInt(num, 10));
                if (amPmStr === 'ì˜¤í›„' && hour !== 12) hour += 12;
                if (amPmStr === 'ì˜¤ì „' && hour === 12) hour = 0;
                return new Date(year, month, day, hour, minute);
            };
            const excelSafeText = (text) => {
                if (/^\d{1,2}[/-]\d{1,2}$/.test(text) || /^\d{1,2}-\d{1,2}$/.test(text)) return "'" + text;
                return text;
            };
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                const adminMatch = trimmedLine.match(adminPattern);
                const systemMatch = trimmedLine.match(systemPattern);
                const chatMatch = trimmedLine.match(chatPattern);
                const isNewMessageLine = adminMatch || systemMatch || chatMatch;
                const isIgnorableLine = dateSeparatorPattern.test(trimmedLine) || timestampOnlyPattern.test(trimmedLine);
                if (isNewMessageLine) {
                    if (currentMessageInfo) chatData.push(currentMessageInfo);
                    currentMessageInfo = null;
                    if (adminMatch) {
                        const [, date, amPm, time, message] = adminMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        chatData.push({ Timestamp: timestamp, User: 'ê´€ë¦¬ì', Message: message });
                    } else if (systemMatch) {
                        const [, date, amPm, time, message] = systemMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        chatData.push({ Timestamp: timestamp, User: 'ì‹œìŠ¤í…œ', Message: message });
                    } else if (chatMatch) {
                        const [, date, amPm, time, user, message] = chatMatch;
                        const timestamp = formatTimestamp(date, amPm, time);
                        const safeMessage = excelSafeText(message);
                        currentMessageInfo = { Timestamp: timestamp, User: user, Message: safeMessage };
                    }
                } else if (!isIgnorableLine && currentMessageInfo) {
                    currentMessageInfo.Message += '\n' + trimmedLine;
                }
            }
            if (currentMessageInfo) chatData.push(currentMessageInfo);
            return chatData;
        }
        
        function convertToCSV(data) {
            if (!data || data.length === 0) return "";
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => {
                    let cell = row[header];
                    if (cell instanceof Date) cell = cell.toISOString();
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('\n') || cell.includes('"'))) {
                        cell = `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }
    </script>
</body>
</html>
